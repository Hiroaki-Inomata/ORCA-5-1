\set ON_ERROR_STOP

-- 点数マスタビューを作成する

DROP VIEW IF EXISTS
    tbl_tensu
;

DROP VIEW IF EXISTS
    view_tensu_master
;

CREATE VIEW
    view_tensu_master
AS
SELECT
    a.srycd,
    a.yukostymd,
    a.yukoedymd,
    a.srykbn,
    a.srysyukbn,
    a.yukoketa,
    a.name,
    a.kanayukoketa,
    a.kananame,
    a.formalyukoketa,
    a.formalname,
    a.tensikibetu,
    a.ten,
    a.tanicd,
    a.tanimojisu,
    a.taniname,
    a.datakbn,
    a.hkntekkbn,
    a.nyugaitekkbn,
    a.routekkbn,
    a.hospsrykbn,
    a.osinkbn,
    a.houksnkbn,
    a.byokanrenkbn,
    a.sdokanryo,
    a.jituday,
    a.daycnt,
    a.ykzknrkbn,
    a.kzmcompsikibetu,
    a.kzmkgn,
    a.kzmjgn,
    a.kzm,
    a.kzmten,
    a.kzmerr,
    a.jgncnt,
    a.jgncnt1d,
    a.jgncnt1w,
    a.jgncntetcm,
    a.jgncntetc,
    a.jgncnterr,
    a.chuksncd,
    a.chuksntsuban,
    a.tsusokuage,
    a.kgnage,
    a.jgnage,
    a.timeksnkbn,
    a.kijunteigenkbn,
    a.kijunteigencd,
    a.laserksn,
    a.chpmesuksn,
    a.micmesuksn,
    a.donorkbn,
    a.knsjiskbn,
    a.knsjisgrpkbn,
    a.teigenkbn,
    a.sekizuisokutei,
    a.keibujyutu,
    a.autohougo,
    a.gaikanrikbn,
    a.tusokugaikbn,
    a.hokatuteigenkbn,
    a.chpnaisiksn,
    a.autofungo,
    a.chiikiksn,
    a.byosyokbn,
    a.chpgyokosotiksn,
    a.shortstayope,
    a.buikbn,
    a.santeirrkkbn,
    a.sstkijuncd1,
    a.sstkijuncd2,
    a.sstkijuncd3,
    a.sstkijuncd4,
    a.sstkijuncd5,
    a.sstkijuncd6,
    a.sstkijuncd7,
    a.sstkijuncd8,
    a.sstkijuncd9,
    a.sstkijuncd10,
    a.ageksnkgn1,
    a.ageksnjgn1,
    a.ageksnsrycd1,
    a.ageksnkgn2,
    a.ageksnjgn2,
    a.ageksnsrycd2,
    a.ageksnkgn3,
    a.ageksnjgn3,
    a.ageksnsrycd3,
    a.ageksnkgn4,
    a.ageksnjgn4,
    a.ageksnsrycd4,
    a.kentaicomment,
    a.nyukhnkbn,
    a.nyukhnksnkbn,
    a.kangoksn,
    a.oldtenskb,
    a.oldten,
    a.madokukbn,
    a.sinkeihakaikbn,
    a.seibutugakukbn,
    a.zoeizaikbn,
    a.csyyouryo,
    a.ykzkbn,
    a.zaigatakbn,
    a.kouhatukbn,
    a.longtoyokbn,
    a.meiuseskb,
    a.tokukizaiageksnkbn,
    a.sansokbn,
    a.tokukizaisbt1,
    a.tokukizaisbt2,
    a.jgnten,
    a.gaitenttlkbn,
    a.nyutenttlkbn,
    a.cdkbn_kbn,
    a.cdkbn_syo,
    a.cdkbn_bu,
    a.cdkbn_kbnnum,
    a.cdkbn_kbnnum_eda,
    a.cdkbn_kouban,
    a.kokuchi_kbn,
    a.kokuchi_syo,
    a.kokuchi_bu,
    a.kokuchi_kbnnum,
    a.kokuchi_kbnnum_eda,
    a.kokuchi_kouban,
    a.kokujiskbkbn1,
    a.kokujiskbkbn2,
    a.namechgkbn,
    a.kananamechgkbn,
    a.idokanren,
    a.kouhyojyunnum,
    a.yakkakjncd,
    a.syusaiskb,
    a.syomeikanren,
    a.chgymd,
    a.haisiymd,
    a.keikasochiymd,
    a.termid,
    a.opid,
    a.creymd,
    a.upymd,
    a.uphms,
    b.hospnum,
    a.gazoopesup,
    a.iryokansatukbn,
    a.masuiskbkbn,
    a.fukubikunaikbn,
    a.fukubikukotukbn,
    a.timemasuikbn,
    a.dpckbn,
    a.hisinsyumonitorksn,
    a.touketuhozonksn,
    a.kubunbangou,
    a.rosaikbn,
    a.sisiksn,
    a.akuseibyoriksn
FROM
    master.tbl_tensu_master a
    CROSS JOIN tbl_sysbase b
;

CREATE VIEW
    tbl_tensu
AS
(
SELECT
    tbl_tensu_user.srycd,
    tbl_tensu_user.yukostymd,
    TO_CHAR(TO_DATE(minymd.yukostymd,'YYYYMMDD')-1,'YYYYMMDD') yukoedymd,
    tbl_tensu_user.srykbn,
    tbl_tensu_user.srysyukbn,
    tbl_tensu_user.yukoketa,
    tbl_tensu_user.name,
    tbl_tensu_user.kanayukoketa,
    tbl_tensu_user.kananame,
    tbl_tensu_user.formalyukoketa,
    tbl_tensu_user.formalname,
    tbl_tensu_user.tensikibetu,
    tbl_tensu_user.ten,
    tbl_tensu_user.tanicd,
    tbl_tensu_user.tanimojisu,
    tbl_tensu_user.taniname,
    tbl_tensu_user.datakbn,
    tbl_tensu_user.hkntekkbn,
    tbl_tensu_user.nyugaitekkbn,
    tbl_tensu_user.routekkbn,
    tbl_tensu_user.hospsrykbn,
    tbl_tensu_user.osinkbn,
    tbl_tensu_user.houksnkbn,
    tbl_tensu_user.byokanrenkbn,
    tbl_tensu_user.sdokanryo,
    tbl_tensu_user.jituday,
    tbl_tensu_user.daycnt,
    tbl_tensu_user.ykzknrkbn,
    tbl_tensu_user.kzmcompsikibetu,
    tbl_tensu_user.kzmkgn,
    tbl_tensu_user.kzmjgn,
    tbl_tensu_user.kzm,
    tbl_tensu_user.kzmten,
    tbl_tensu_user.kzmerr,
    tbl_tensu_user.jgncnt,
    tbl_tensu_user.jgncnt1d,
    tbl_tensu_user.jgncnt1w,
    tbl_tensu_user.jgncntetcm,
    tbl_tensu_user.jgncntetc,
    tbl_tensu_user.jgncnterr,
    tbl_tensu_user.chuksncd,
    tbl_tensu_user.chuksntsuban,
    tbl_tensu_user.tsusokuage,
    tbl_tensu_user.kgnage,
    tbl_tensu_user.jgnage,
    tbl_tensu_user.timeksnkbn,
    tbl_tensu_user.kijunteigenkbn,
    tbl_tensu_user.kijunteigencd,
    tbl_tensu_user.laserksn,
    tbl_tensu_user.chpmesuksn,
    tbl_tensu_user.micmesuksn,
    tbl_tensu_user.donorkbn,
    tbl_tensu_user.knsjiskbn,
    tbl_tensu_user.knsjisgrpkbn,
    tbl_tensu_user.teigenkbn,
    tbl_tensu_user.sekizuisokutei,
    tbl_tensu_user.keibujyutu,
    tbl_tensu_user.autohougo,
    tbl_tensu_user.gaikanrikbn,
    tbl_tensu_user.tusokugaikbn,
    tbl_tensu_user.hokatuteigenkbn,
    tbl_tensu_user.chpnaisiksn,
    tbl_tensu_user.autofungo,
    tbl_tensu_user.chiikiksn,
    tbl_tensu_user.byosyokbn,
    tbl_tensu_user.chpgyokosotiksn,
    tbl_tensu_user.shortstayope,
    tbl_tensu_user.buikbn,
    tbl_tensu_user.santeirrkkbn,
    tbl_tensu_user.sstkijuncd1,
    tbl_tensu_user.sstkijuncd2,
    tbl_tensu_user.sstkijuncd3,
    tbl_tensu_user.sstkijuncd4,
    tbl_tensu_user.sstkijuncd5,
    tbl_tensu_user.sstkijuncd6,
    tbl_tensu_user.sstkijuncd7,
    tbl_tensu_user.sstkijuncd8,
    tbl_tensu_user.sstkijuncd9,
    tbl_tensu_user.sstkijuncd10,
    tbl_tensu_user.ageksnkgn1,
    tbl_tensu_user.ageksnjgn1,
    tbl_tensu_user.ageksnsrycd1,
    tbl_tensu_user.ageksnkgn2,
    tbl_tensu_user.ageksnjgn2,
    tbl_tensu_user.ageksnsrycd2,
    tbl_tensu_user.ageksnkgn3,
    tbl_tensu_user.ageksnjgn3,
    tbl_tensu_user.ageksnsrycd3,
    tbl_tensu_user.ageksnkgn4,
    tbl_tensu_user.ageksnjgn4,
    tbl_tensu_user.ageksnsrycd4,
    tbl_tensu_user.kentaicomment,
    tbl_tensu_user.nyukhnkbn,
    tbl_tensu_user.nyukhnksnkbn,
    tbl_tensu_user.kangoksn,
    tbl_tensu_user.oldtenskb,
    tbl_tensu_user.oldten,
    tbl_tensu_user.madokukbn,
    tbl_tensu_user.sinkeihakaikbn,
    tbl_tensu_user.seibutugakukbn,
    tbl_tensu_user.zoeizaikbn,
    tbl_tensu_user.csyyouryo,
    tbl_tensu_user.ykzkbn,
    tbl_tensu_user.zaigatakbn,
    tbl_tensu_user.kouhatukbn,
    tbl_tensu_user.longtoyokbn,
    tbl_tensu_user.meiuseskb,
    tbl_tensu_user.tokukizaiageksnkbn,
    tbl_tensu_user.sansokbn,
    tbl_tensu_user.tokukizaisbt1,
    tbl_tensu_user.tokukizaisbt2,
    tbl_tensu_user.jgnten,
    tbl_tensu_user.gaitenttlkbn,
    tbl_tensu_user.nyutenttlkbn,
    tbl_tensu_user.cdkbn_kbn,
    tbl_tensu_user.cdkbn_syo,
    tbl_tensu_user.cdkbn_bu,
    tbl_tensu_user.cdkbn_kbnnum,
    tbl_tensu_user.cdkbn_kbnnum_eda,
    tbl_tensu_user.cdkbn_kouban,
    tbl_tensu_user.kokuchi_kbn,
    tbl_tensu_user.kokuchi_syo,
    tbl_tensu_user.kokuchi_bu,
    tbl_tensu_user.kokuchi_kbnnum,
    tbl_tensu_user.kokuchi_kbnnum_eda,
    tbl_tensu_user.kokuchi_kouban,
    tbl_tensu_user.kokujiskbkbn1,
    tbl_tensu_user.kokujiskbkbn2,
    tbl_tensu_user.namechgkbn,
    tbl_tensu_user.kananamechgkbn,
    tbl_tensu_user.idokanren,
    tbl_tensu_user.kouhyojyunnum,
    tbl_tensu_user.yakkakjncd,
    tbl_tensu_user.syusaiskb,
    tbl_tensu_user.syomeikanren,
    tbl_tensu_user.chgymd,
    tbl_tensu_user.haisiymd,
    tbl_tensu_user.keikasochiymd,
    tbl_tensu_user.termid,
    tbl_tensu_user.opid,
    tbl_tensu_user.creymd,
    tbl_tensu_user.upymd,
    tbl_tensu_user.uphms,
    tbl_tensu_user.hospnum,
    tbl_tensu_user.gazoopesup,
    tbl_tensu_user.iryokansatukbn,
    tbl_tensu_user.masuiskbkbn,
    tbl_tensu_user.fukubikunaikbn,
    tbl_tensu_user.fukubikukotukbn,
    tbl_tensu_user.timemasuikbn,
    tbl_tensu_user.dpckbn,
    tbl_tensu_user.hisinsyumonitorksn,
    tbl_tensu_user.touketuhozonksn,
    tbl_tensu_user.kubunbangou,
    tbl_tensu_user.rosaikbn,
    tbl_tensu_user.sisiksn,
    tbl_tensu_user.akuseibyoriksn,
    '2'::smallint AS master_class
FROM
    tbl_tensu_user
    INNER JOIN
    (SELECT hospnum,srycd,min(yukostymd) yukostymd FROM tbl_tensu_price group by hospnum,srycd) minymd
    ON
    tbl_tensu_user.hospnum = minymd.hospnum AND
    tbl_tensu_user.srycd = minymd.srycd AND
    tbl_tensu_user.yukostymd < minymd.yukostymd AND
    tbl_tensu_user.yukoedymd > minymd.yukostymd
UNION
SELECT
    tbl_tensu_user.srycd,
    greatest(tbl_tensu_user.yukostymd, tbl_tensu_price.yukostymd) AS yukostymd,
    least(tbl_tensu_user.yukoedymd, tbl_tensu_price.yukoedymd) AS yukoedymd,
    tbl_tensu_user.srykbn,
    tbl_tensu_user.srysyukbn,
    tbl_tensu_user.yukoketa,
    tbl_tensu_user.name,
    tbl_tensu_user.kanayukoketa,
    tbl_tensu_user.kananame,
    tbl_tensu_user.formalyukoketa,
    tbl_tensu_user.formalname,
    tbl_tensu_user.tensikibetu,
    CASE
        WHEN tbl_tensu_price.price ISNULL THEN tbl_tensu_user.ten
        ELSE tbl_tensu_price.price
    END AS ten,
    tbl_tensu_user.tanicd,
    tbl_tensu_user.tanimojisu,
    tbl_tensu_user.taniname,
    tbl_tensu_user.datakbn,
    tbl_tensu_user.hkntekkbn,
    tbl_tensu_user.nyugaitekkbn,
    tbl_tensu_user.routekkbn,
    tbl_tensu_user.hospsrykbn,
    tbl_tensu_user.osinkbn,
    tbl_tensu_user.houksnkbn,
    tbl_tensu_user.byokanrenkbn,
    tbl_tensu_user.sdokanryo,
    tbl_tensu_user.jituday,
    tbl_tensu_user.daycnt,
    tbl_tensu_user.ykzknrkbn,
    tbl_tensu_user.kzmcompsikibetu,
    tbl_tensu_user.kzmkgn,
    tbl_tensu_user.kzmjgn,
    tbl_tensu_user.kzm,
    tbl_tensu_user.kzmten,
    tbl_tensu_user.kzmerr,
    tbl_tensu_user.jgncnt,
    tbl_tensu_user.jgncnt1d,
    tbl_tensu_user.jgncnt1w,
    tbl_tensu_user.jgncntetcm,
    tbl_tensu_user.jgncntetc,
    tbl_tensu_user.jgncnterr,
    tbl_tensu_user.chuksncd,
    tbl_tensu_user.chuksntsuban,
    tbl_tensu_user.tsusokuage,
    tbl_tensu_user.kgnage,
    tbl_tensu_user.jgnage,
    tbl_tensu_user.timeksnkbn,
    tbl_tensu_user.kijunteigenkbn,
    tbl_tensu_user.kijunteigencd,
    tbl_tensu_user.laserksn,
    tbl_tensu_user.chpmesuksn,
    tbl_tensu_user.micmesuksn,
    tbl_tensu_user.donorkbn,
    tbl_tensu_user.knsjiskbn,
    tbl_tensu_user.knsjisgrpkbn,
    tbl_tensu_user.teigenkbn,
    tbl_tensu_user.sekizuisokutei,
    tbl_tensu_user.keibujyutu,
    tbl_tensu_user.autohougo,
    tbl_tensu_user.gaikanrikbn,
    tbl_tensu_user.tusokugaikbn,
    tbl_tensu_user.hokatuteigenkbn,
    tbl_tensu_user.chpnaisiksn,
    tbl_tensu_user.autofungo,
    tbl_tensu_user.chiikiksn,
    tbl_tensu_user.byosyokbn,
    tbl_tensu_user.chpgyokosotiksn,
    tbl_tensu_user.shortstayope,
    tbl_tensu_user.buikbn,
    tbl_tensu_user.santeirrkkbn,
    tbl_tensu_user.sstkijuncd1,
    tbl_tensu_user.sstkijuncd2,
    tbl_tensu_user.sstkijuncd3,
    tbl_tensu_user.sstkijuncd4,
    tbl_tensu_user.sstkijuncd5,
    tbl_tensu_user.sstkijuncd6,
    tbl_tensu_user.sstkijuncd7,
    tbl_tensu_user.sstkijuncd8,
    tbl_tensu_user.sstkijuncd9,
    tbl_tensu_user.sstkijuncd10,
    tbl_tensu_user.ageksnkgn1,
    tbl_tensu_user.ageksnjgn1,
    tbl_tensu_user.ageksnsrycd1,
    tbl_tensu_user.ageksnkgn2,
    tbl_tensu_user.ageksnjgn2,
    tbl_tensu_user.ageksnsrycd2,
    tbl_tensu_user.ageksnkgn3,
    tbl_tensu_user.ageksnjgn3,
    tbl_tensu_user.ageksnsrycd3,
    tbl_tensu_user.ageksnkgn4,
    tbl_tensu_user.ageksnjgn4,
    tbl_tensu_user.ageksnsrycd4,
    tbl_tensu_user.kentaicomment,
    tbl_tensu_user.nyukhnkbn,
    tbl_tensu_user.nyukhnksnkbn,
    tbl_tensu_user.kangoksn,
    tbl_tensu_user.oldtenskb,
    tbl_tensu_user.oldten,
    tbl_tensu_user.madokukbn,
    tbl_tensu_user.sinkeihakaikbn,
    tbl_tensu_user.seibutugakukbn,
    tbl_tensu_user.zoeizaikbn,
    tbl_tensu_user.csyyouryo,
    tbl_tensu_user.ykzkbn,
    tbl_tensu_user.zaigatakbn,
    tbl_tensu_user.kouhatukbn,
    tbl_tensu_user.longtoyokbn,
    tbl_tensu_user.meiuseskb,
    tbl_tensu_user.tokukizaiageksnkbn,
    tbl_tensu_user.sansokbn,
    tbl_tensu_user.tokukizaisbt1,
    tbl_tensu_user.tokukizaisbt2,
    tbl_tensu_user.jgnten,
    tbl_tensu_user.gaitenttlkbn,
    tbl_tensu_user.nyutenttlkbn,
    tbl_tensu_user.cdkbn_kbn,
    tbl_tensu_user.cdkbn_syo,
    tbl_tensu_user.cdkbn_bu,
    tbl_tensu_user.cdkbn_kbnnum,
    tbl_tensu_user.cdkbn_kbnnum_eda,
    tbl_tensu_user.cdkbn_kouban,
    tbl_tensu_user.kokuchi_kbn,
    tbl_tensu_user.kokuchi_syo,
    tbl_tensu_user.kokuchi_bu,
    tbl_tensu_user.kokuchi_kbnnum,
    tbl_tensu_user.kokuchi_kbnnum_eda,
    tbl_tensu_user.kokuchi_kouban,
    tbl_tensu_user.kokujiskbkbn1,
    tbl_tensu_user.kokujiskbkbn2,
    tbl_tensu_user.namechgkbn,
    tbl_tensu_user.kananamechgkbn,
    tbl_tensu_user.idokanren,
    tbl_tensu_user.kouhyojyunnum,
    tbl_tensu_user.yakkakjncd,
    tbl_tensu_user.syusaiskb,
    tbl_tensu_user.syomeikanren,
    tbl_tensu_user.chgymd,
    tbl_tensu_user.haisiymd,
    tbl_tensu_user.keikasochiymd,
    tbl_tensu_user.termid,
    tbl_tensu_user.opid,
    tbl_tensu_user.creymd,
    tbl_tensu_user.upymd,
    tbl_tensu_user.uphms,
    tbl_tensu_user.hospnum,
    tbl_tensu_user.gazoopesup,
    tbl_tensu_user.iryokansatukbn,
    tbl_tensu_user.masuiskbkbn,
    tbl_tensu_user.fukubikunaikbn,
    tbl_tensu_user.fukubikukotukbn,
    tbl_tensu_user.timemasuikbn,
    tbl_tensu_user.dpckbn,
    tbl_tensu_user.hisinsyumonitorksn,
    tbl_tensu_user.touketuhozonksn,
    tbl_tensu_user.kubunbangou,
    tbl_tensu_user.rosaikbn,
    tbl_tensu_user.sisiksn,
    tbl_tensu_user.akuseibyoriksn,
    '2'::smallint AS master_class
FROM
    tbl_tensu_user
    LEFT OUTER JOIN tbl_tensu_price
    ON 
    tbl_tensu_user.hospnum = tbl_tensu_price.hospnum AND
    tbl_tensu_user.srycd = tbl_tensu_price.srycd AND
    tbl_tensu_user.yukostymd <= tbl_tensu_price.yukoedymd AND
    tbl_tensu_user.yukoedymd >= tbl_tensu_price.yukostymd
UNION
SELECT
    view_tensu_master.srycd,
    view_tensu_master.yukostymd,
    TO_CHAR(TO_DATE(minymd.yukostymd,'YYYYMMDD')-1,'YYYYMMDD') yukoedymd,
    view_tensu_master.srykbn,
    view_tensu_master.srysyukbn,
    view_tensu_master.yukoketa,
    view_tensu_master.name,
    view_tensu_master.kanayukoketa,
    view_tensu_master.kananame,
    view_tensu_master.formalyukoketa,
    view_tensu_master.formalname,
    view_tensu_master.tensikibetu,
    view_tensu_master.ten,
    view_tensu_master.tanicd,
    view_tensu_master.tanimojisu,
    view_tensu_master.taniname,
    view_tensu_master.datakbn,
    view_tensu_master.hkntekkbn,
    view_tensu_master.nyugaitekkbn,
    view_tensu_master.routekkbn,
    view_tensu_master.hospsrykbn,
    view_tensu_master.osinkbn,
    view_tensu_master.houksnkbn,
    view_tensu_master.byokanrenkbn,
    view_tensu_master.sdokanryo,
    view_tensu_master.jituday,
    view_tensu_master.daycnt,
    view_tensu_master.ykzknrkbn,
    view_tensu_master.kzmcompsikibetu,
    view_tensu_master.kzmkgn,
    view_tensu_master.kzmjgn,
    view_tensu_master.kzm,
    view_tensu_master.kzmten,
    view_tensu_master.kzmerr,
    view_tensu_master.jgncnt,
    view_tensu_master.jgncnt1d,
    view_tensu_master.jgncnt1w,
    view_tensu_master.jgncntetcm,
    view_tensu_master.jgncntetc,
    view_tensu_master.jgncnterr,
    view_tensu_master.chuksncd,
    view_tensu_master.chuksntsuban,
    view_tensu_master.tsusokuage,
    view_tensu_master.kgnage,
    view_tensu_master.jgnage,
    view_tensu_master.timeksnkbn,
    view_tensu_master.kijunteigenkbn,
    view_tensu_master.kijunteigencd,
    view_tensu_master.laserksn,
    view_tensu_master.chpmesuksn,
    view_tensu_master.micmesuksn,
    view_tensu_master.donorkbn,
    view_tensu_master.knsjiskbn,
    view_tensu_master.knsjisgrpkbn,
    view_tensu_master.teigenkbn,
    view_tensu_master.sekizuisokutei,
    view_tensu_master.keibujyutu,
    view_tensu_master.autohougo,
    view_tensu_master.gaikanrikbn,
    view_tensu_master.tusokugaikbn,
    view_tensu_master.hokatuteigenkbn,
    view_tensu_master.chpnaisiksn,
    view_tensu_master.autofungo,
    view_tensu_master.chiikiksn,
    view_tensu_master.byosyokbn,
    view_tensu_master.chpgyokosotiksn,
    view_tensu_master.shortstayope,
    view_tensu_master.buikbn,
    view_tensu_master.santeirrkkbn,
    view_tensu_master.sstkijuncd1,
    view_tensu_master.sstkijuncd2,
    view_tensu_master.sstkijuncd3,
    view_tensu_master.sstkijuncd4,
    view_tensu_master.sstkijuncd5,
    view_tensu_master.sstkijuncd6,
    view_tensu_master.sstkijuncd7,
    view_tensu_master.sstkijuncd8,
    view_tensu_master.sstkijuncd9,
    view_tensu_master.sstkijuncd10,
    view_tensu_master.ageksnkgn1,
    view_tensu_master.ageksnjgn1,
    view_tensu_master.ageksnsrycd1,
    view_tensu_master.ageksnkgn2,
    view_tensu_master.ageksnjgn2,
    view_tensu_master.ageksnsrycd2,
    view_tensu_master.ageksnkgn3,
    view_tensu_master.ageksnjgn3,
    view_tensu_master.ageksnsrycd3,
    view_tensu_master.ageksnkgn4,
    view_tensu_master.ageksnjgn4,
    view_tensu_master.ageksnsrycd4,
    view_tensu_master.kentaicomment,
    view_tensu_master.nyukhnkbn,
    view_tensu_master.nyukhnksnkbn,
    view_tensu_master.kangoksn,
    view_tensu_master.oldtenskb,
    view_tensu_master.oldten,
    view_tensu_master.madokukbn,
    view_tensu_master.sinkeihakaikbn,
    view_tensu_master.seibutugakukbn,
    view_tensu_master.zoeizaikbn,
    view_tensu_master.csyyouryo,
    view_tensu_master.ykzkbn,
    view_tensu_master.zaigatakbn,
    view_tensu_master.kouhatukbn,
    view_tensu_master.longtoyokbn,
    view_tensu_master.meiuseskb,
    view_tensu_master.tokukizaiageksnkbn,
    view_tensu_master.sansokbn,
    view_tensu_master.tokukizaisbt1,
    view_tensu_master.tokukizaisbt2,
    view_tensu_master.jgnten,
    view_tensu_master.gaitenttlkbn,
    view_tensu_master.nyutenttlkbn,
    view_tensu_master.cdkbn_kbn,
    view_tensu_master.cdkbn_syo,
    view_tensu_master.cdkbn_bu,
    view_tensu_master.cdkbn_kbnnum,
    view_tensu_master.cdkbn_kbnnum_eda,
    view_tensu_master.cdkbn_kouban,
    view_tensu_master.kokuchi_kbn,
    view_tensu_master.kokuchi_syo,
    view_tensu_master.kokuchi_bu,
    view_tensu_master.kokuchi_kbnnum,
    view_tensu_master.kokuchi_kbnnum_eda,
    view_tensu_master.kokuchi_kouban,
    view_tensu_master.kokujiskbkbn1,
    view_tensu_master.kokujiskbkbn2,
    view_tensu_master.namechgkbn,
    view_tensu_master.kananamechgkbn,
    view_tensu_master.idokanren,
    view_tensu_master.kouhyojyunnum,
    view_tensu_master.yakkakjncd,
    view_tensu_master.syusaiskb,
    view_tensu_master.syomeikanren,
    view_tensu_master.chgymd,
    view_tensu_master.haisiymd,
    view_tensu_master.keikasochiymd,
    view_tensu_master.termid,
    view_tensu_master.opid,
    view_tensu_master.creymd,
    view_tensu_master.upymd,
    view_tensu_master.uphms,
    view_tensu_master.hospnum,
    view_tensu_master.gazoopesup,
    view_tensu_master.iryokansatukbn,
    view_tensu_master.masuiskbkbn,
    view_tensu_master.fukubikunaikbn,
    view_tensu_master.fukubikukotukbn,
    view_tensu_master.timemasuikbn,
    view_tensu_master.dpckbn,
    view_tensu_master.hisinsyumonitorksn,
    view_tensu_master.touketuhozonksn,
    view_tensu_master.kubunbangou,
    view_tensu_master.rosaikbn,
    view_tensu_master.sisiksn,
    view_tensu_master.akuseibyoriksn,
    '1'::smallint AS master_class
FROM
    view_tensu_master
    INNER JOIN
    (SELECT hospnum,srycd,min(yukostymd) yukostymd FROM tbl_tensu_price group by hospnum,srycd) minymd
    ON
    view_tensu_master.hospnum = minymd.hospnum AND
    view_tensu_master.srycd = minymd.srycd AND
    view_tensu_master.yukostymd < minymd.yukostymd AND
    view_tensu_master.yukoedymd > minymd.yukostymd
WHERE
    NOT EXISTS (
        SELECT
            1
        FROM
            tbl_tensu_user
        WHERE
            ( view_tensu_master.hospnum = tbl_tensu_user.hospnum ) AND
            ( view_tensu_master.srycd = tbl_tensu_user.srycd )
        )
UNION
SELECT
    view_tensu_master.srycd,
    greatest(view_tensu_master.yukostymd, tbl_tensu_price.yukostymd) AS yukostymd,
    least(view_tensu_master.yukoedymd, tbl_tensu_price.yukoedymd) AS yukoedymd,
    view_tensu_master.srykbn,
    view_tensu_master.srysyukbn,
    view_tensu_master.yukoketa,
    view_tensu_master.name,
    view_tensu_master.kanayukoketa,
    view_tensu_master.kananame,
    view_tensu_master.formalyukoketa,
    view_tensu_master.formalname,
    view_tensu_master.tensikibetu,
    CASE
        WHEN tbl_tensu_price.price ISNULL THEN view_tensu_master.ten
        ELSE tbl_tensu_price.price
    END AS ten,
    view_tensu_master.tanicd,
    view_tensu_master.tanimojisu,
    view_tensu_master.taniname,
    view_tensu_master.datakbn,
    view_tensu_master.hkntekkbn,
    view_tensu_master.nyugaitekkbn,
    view_tensu_master.routekkbn,
    view_tensu_master.hospsrykbn,
    view_tensu_master.osinkbn,
    view_tensu_master.houksnkbn,
    view_tensu_master.byokanrenkbn,
    view_tensu_master.sdokanryo,
    view_tensu_master.jituday,
    view_tensu_master.daycnt,
    view_tensu_master.ykzknrkbn,
    view_tensu_master.kzmcompsikibetu,
    view_tensu_master.kzmkgn,
    view_tensu_master.kzmjgn,
    view_tensu_master.kzm,
    view_tensu_master.kzmten,
    view_tensu_master.kzmerr,
    view_tensu_master.jgncnt,
    view_tensu_master.jgncnt1d,
    view_tensu_master.jgncnt1w,
    view_tensu_master.jgncntetcm,
    view_tensu_master.jgncntetc,
    view_tensu_master.jgncnterr,
    view_tensu_master.chuksncd,
    view_tensu_master.chuksntsuban,
    view_tensu_master.tsusokuage,
    view_tensu_master.kgnage,
    view_tensu_master.jgnage,
    view_tensu_master.timeksnkbn,
    view_tensu_master.kijunteigenkbn,
    view_tensu_master.kijunteigencd,
    view_tensu_master.laserksn,
    view_tensu_master.chpmesuksn,
    view_tensu_master.micmesuksn,
    view_tensu_master.donorkbn,
    view_tensu_master.knsjiskbn,
    view_tensu_master.knsjisgrpkbn,
    view_tensu_master.teigenkbn,
    view_tensu_master.sekizuisokutei,
    view_tensu_master.keibujyutu,
    view_tensu_master.autohougo,
    view_tensu_master.gaikanrikbn,
    view_tensu_master.tusokugaikbn,
    view_tensu_master.hokatuteigenkbn,
    view_tensu_master.chpnaisiksn,
    view_tensu_master.autofungo,
    view_tensu_master.chiikiksn,
    view_tensu_master.byosyokbn,
    view_tensu_master.chpgyokosotiksn,
    view_tensu_master.shortstayope,
    view_tensu_master.buikbn,
    view_tensu_master.santeirrkkbn,
    view_tensu_master.sstkijuncd1,
    view_tensu_master.sstkijuncd2,
    view_tensu_master.sstkijuncd3,
    view_tensu_master.sstkijuncd4,
    view_tensu_master.sstkijuncd5,
    view_tensu_master.sstkijuncd6,
    view_tensu_master.sstkijuncd7,
    view_tensu_master.sstkijuncd8,
    view_tensu_master.sstkijuncd9,
    view_tensu_master.sstkijuncd10,
    view_tensu_master.ageksnkgn1,
    view_tensu_master.ageksnjgn1,
    view_tensu_master.ageksnsrycd1,
    view_tensu_master.ageksnkgn2,
    view_tensu_master.ageksnjgn2,
    view_tensu_master.ageksnsrycd2,
    view_tensu_master.ageksnkgn3,
    view_tensu_master.ageksnjgn3,
    view_tensu_master.ageksnsrycd3,
    view_tensu_master.ageksnkgn4,
    view_tensu_master.ageksnjgn4,
    view_tensu_master.ageksnsrycd4,
    view_tensu_master.kentaicomment,
    view_tensu_master.nyukhnkbn,
    view_tensu_master.nyukhnksnkbn,
    view_tensu_master.kangoksn,
    view_tensu_master.oldtenskb,
    view_tensu_master.oldten,
    view_tensu_master.madokukbn,
    view_tensu_master.sinkeihakaikbn,
    view_tensu_master.seibutugakukbn,
    view_tensu_master.zoeizaikbn,
    view_tensu_master.csyyouryo,
    view_tensu_master.ykzkbn,
    view_tensu_master.zaigatakbn,
    view_tensu_master.kouhatukbn,
    view_tensu_master.longtoyokbn,
    view_tensu_master.meiuseskb,
    view_tensu_master.tokukizaiageksnkbn,
    view_tensu_master.sansokbn,
    view_tensu_master.tokukizaisbt1,
    view_tensu_master.tokukizaisbt2,
    view_tensu_master.jgnten,
    view_tensu_master.gaitenttlkbn,
    view_tensu_master.nyutenttlkbn,
    view_tensu_master.cdkbn_kbn,
    view_tensu_master.cdkbn_syo,
    view_tensu_master.cdkbn_bu,
    view_tensu_master.cdkbn_kbnnum,
    view_tensu_master.cdkbn_kbnnum_eda,
    view_tensu_master.cdkbn_kouban,
    view_tensu_master.kokuchi_kbn,
    view_tensu_master.kokuchi_syo,
    view_tensu_master.kokuchi_bu,
    view_tensu_master.kokuchi_kbnnum,
    view_tensu_master.kokuchi_kbnnum_eda,
    view_tensu_master.kokuchi_kouban,
    view_tensu_master.kokujiskbkbn1,
    view_tensu_master.kokujiskbkbn2,
    view_tensu_master.namechgkbn,
    view_tensu_master.kananamechgkbn,
    view_tensu_master.idokanren,
    view_tensu_master.kouhyojyunnum,
    view_tensu_master.yakkakjncd,
    view_tensu_master.syusaiskb,
    view_tensu_master.syomeikanren,
    view_tensu_master.chgymd,
    view_tensu_master.haisiymd,
    view_tensu_master.keikasochiymd,
    view_tensu_master.termid,
    view_tensu_master.opid,
    view_tensu_master.creymd,
    view_tensu_master.upymd,
    view_tensu_master.uphms,
    view_tensu_master.hospnum,
    view_tensu_master.gazoopesup,
    view_tensu_master.iryokansatukbn,
    view_tensu_master.masuiskbkbn,
    view_tensu_master.fukubikunaikbn,
    view_tensu_master.fukubikukotukbn,
    view_tensu_master.timemasuikbn,
    view_tensu_master.dpckbn,
    view_tensu_master.hisinsyumonitorksn,
    view_tensu_master.touketuhozonksn,
    view_tensu_master.kubunbangou,
    view_tensu_master.rosaikbn,
    view_tensu_master.sisiksn,
    view_tensu_master.akuseibyoriksn,
    '1'::smallint AS master_class
FROM
    view_tensu_master
    LEFT OUTER JOIN tbl_tensu_price
    ON 
    view_tensu_master.hospnum = tbl_tensu_price.hospnum AND
    view_tensu_master.srycd = tbl_tensu_price.srycd AND
    view_tensu_master.yukostymd <= tbl_tensu_price.yukoedymd AND
    view_tensu_master.yukoedymd >= tbl_tensu_price.yukostymd
WHERE
    NOT EXISTS (
        SELECT
            1
        FROM
            tbl_tensu_user
        WHERE
            ( view_tensu_master.hospnum = tbl_tensu_user.hospnum ) AND
            ( view_tensu_master.srycd = tbl_tensu_user.srycd )
        )
ORDER BY
    hospnum,
    srycd,
    yukostymd
)
;
