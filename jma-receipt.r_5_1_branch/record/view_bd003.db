view_bd003 {

#   SKYMONEY,NYUHEN_MONEYは
#   集計に使いたいので10桁とっておく


	HOSPNUM				number(2,0);
	NYUGAIKBN			char(1);
	PTID				number(10,0);
	DENPNUM          	number(7,0);
	DENPEDANUM			number(2,0);
	SKYMONEY			number(10,0);
	NYUHEN_MONEY		number(10,0);
	NYUHEN_YMD			char(8);
	SRYYMD              char(8);
#-----> 検索用項目
	STSRYYMD			char(8),virtual;
	EDSRYYMD			char(8),virtual;
};

path	key 	{
	DBSELECT	{
		DECLARE view_bd003_key_csr CURSOR FOR
		SELECT PTID,SUM(SKYMONEY) AS SKYMONEY,SUM(NYUHEN_MONEY) AS NYUHEN_MONEY
		FROM view_bd003
		WHERE	HOSPNUM             = :HOSPNUM
		AND		NYUHEN_YMD        <= :NYUHEN_YMD
		AND		(SRYYMD BETWEEN :STSRYYMD  AND :EDSRYYMD )
		GROUP BY PTID HAVING SUM(SKYMONEY) <> SUM(NYUHEN_MONEY)
		;
	};
};

path	key2 	{
	DBSELECT	{
		DECLARE view_bd003_key2_csr CURSOR FOR
		SELECT  HOSPNUM,NYUGAIKBN,PTID,DENPNUM,SRYYMD
		       ,SUM(SKYMONEY) AS SKYMONEY,SUM(NYUHEN_MONEY) AS NYUHEN_MONEY
		FROM view_bd003
		WHERE	HOSPNUM             = :HOSPNUM
		AND		NYUGAIKBN          LIKE :NYUGAIKBN
		AND     NYUHEN_YMD        <= :NYUHEN_YMD
		AND		(SRYYMD BETWEEN :STSRYYMD  AND :EDSRYYMD )
		GROUP BY HOSPNUM,NYUGAIKBN,PTID,DENPNUM,SRYYMD
		HAVING  SUM(SKYMONEY) <> SUM(NYUHEN_MONEY)
		;
	};
};

path	key3 	{
	DBSELECT	{
		DECLARE view_bd003_key3_csr CURSOR FOR
		SELECT  HOSPNUM,PTID
		       ,MAX(NYUHEN_YMD) AS NYUHEN_YMD
		FROM view_bd003
		WHERE	HOSPNUM             = :HOSPNUM
		AND		PTID               = :PTID
		AND		NYUHEN_MONEY	   > 0
		AND     NYUHEN_YMD        <= :NYUHEN_YMD
		AND		(SRYYMD BETWEEN :STSRYYMD  AND :EDSRYYMD )
		GROUP BY HOSPNUM,PTID
		;
	};
};

path	all 	{
	DBSELECT	{
		DECLARE view_bd003_all_csr CURSOR FOR
		SELECT *
		FROM view_bd003
		WHERE	HOSPNUM             = :HOSPNUM
		;
	};
};


path	key4 	{
	DBSELECT	{
		DECLARE view_bd003_key4_csr CURSOR FOR
		SELECT NYUGAIKBN,SUM(SKYMONEY) AS SKYMONEY
		FROM view_bd003
		WHERE	HOSPNUM         = :HOSPNUM
           	AND	NYUGAIKBN    LIKE :NYUGAIKBN
           	AND	PTID            = :PTID
           	AND	SRYYMD       LIKE :SRYYMD
		GROUP BY NYUGAIKBN
		;
	};
};

path	key5 	{
	DBSELECT	{
		DECLARE view_bd003_key5_csr CURSOR FOR
		SELECT PTID,SUM(SKYMONEY) AS SKYMONEY,SUM(NYUHEN_MONEY) AS NYUHEN_MONEY
		FROM view_bd003 
		WHERE	HOSPNUM            = :HOSPNUM
		AND		NYUHEN_YMD        <= :NYUHEN_YMD
        AND   ( HOSPNUM,NYUGAIKBN,PTID,DENPNUM) IN
        (SELECT HOSPNUM,NYUGAIKBN,PTID,DENPNUM FROM TBL_SYUMEI
         WHERE  HOSPNUM            = :HOSPNUM
            AND NYUHEN_YMD BETWEEN :STSRYYMD  AND :EDSRYYMD 
            AND DENPEDANUM = 1)
		GROUP BY PTID
		HAVING  SUM(SKYMONEY) <> SUM(NYUHEN_MONEY)
	};
};

path	key6 	{
	DBSELECT	{
		DECLARE view_bd003_key6_csr CURSOR FOR
		SELECT  HOSPNUM,NYUGAIKBN,PTID,DENPNUM,SRYYMD
		       ,SUM(SKYMONEY) AS SKYMONEY,SUM(NYUHEN_MONEY) AS NYUHEN_MONEY
		FROM view_bd003
		WHERE	HOSPNUM             = :HOSPNUM
		AND		NYUGAIKBN          LIKE :NYUGAIKBN
		AND     NYUHEN_YMD        <= :NYUHEN_YMD
        AND   ( HOSPNUM,NYUGAIKBN,PTID,DENPNUM) IN
        (SELECT HOSPNUM,NYUGAIKBN,PTID,DENPNUM FROM TBL_SYUMEI
         WHERE  HOSPNUM            = :HOSPNUM
            AND NYUHEN_YMD BETWEEN :STSRYYMD  AND :EDSRYYMD 
            AND DENPEDANUM = 1)
		GROUP BY HOSPNUM,NYUGAIKBN,PTID,DENPNUM,SRYYMD
		HAVING  SUM(SKYMONEY) <> SUM(NYUHEN_MONEY)
		;
	};
};

path	key7 	{
	DBSELECT	{
		DECLARE view_bd003_key7_csr CURSOR FOR
		SELECT  HOSPNUM,PTID
		       ,MAX(NYUHEN_YMD) AS NYUHEN_YMD
		FROM view_bd003
		WHERE	HOSPNUM             = :HOSPNUM
		AND		PTID               = :PTID
		AND		NYUHEN_MONEY	   > 0
		AND     NYUHEN_YMD        <= :NYUHEN_YMD
        AND   ( HOSPNUM,NYUGAIKBN,PTID,DENPNUM) IN
        (SELECT HOSPNUM,NYUGAIKBN,PTID,DENPNUM FROM TBL_SYUMEI
         WHERE  HOSPNUM            = :HOSPNUM
            AND NYUHEN_YMD BETWEEN :STSRYYMD  AND :EDSRYYMD 
            AND DENPEDANUM = 1)
		GROUP BY HOSPNUM,PTID
		;
	};
};

